---
import type { Question, Level } from '../types/exercise';

interface Props {
  questions: Question[];
  level: Level;
  title: string;
}

const { questions, level, title } = Astro.props;
const memoryId = `memory-${Math.random().toString(36).slice(2, 9)}`;
const pairCount = level === 'CP' ? 4 : level === 'CE1' ? 6 : 8;
---

<div class="memory-game" id={memoryId}>
  <div class="memory-header">
    <h2 class="memory-title">üÉè {title}</h2>
    <div class="memory-stats">
      <span class="memory-pairs">‚≠ê Paires : <strong>0</strong> / <span class="total-pairs">{pairCount}</span></span>
      <span class="memory-moves">üîÑ Coups : <strong>0</strong></span>
    </div>
  </div>
  
  <div class="memory-grid"></div>
  
  <div class="memory-win" hidden>
    <span class="win-emoji">üéâ</span>
    <p class="win-text">Bravo !</p>
    <p class="win-stats"></p>
    <button type="button" class="btn btn--primary btn--lg replay-btn">üîÑ Rejouer</button>
  </div>
</div>

<script define:vars={{ questions, memoryId, pairCount }}>
  const container = document.getElementById(memoryId);
  if (!container) throw new Error('Memory container not found');

  let cards = [];
  let flippedCards = [];
  let matchedPairs = 0;
  let moves = 0;
  let isLocked = false;

  const grid = container.querySelector('.memory-grid');
  const pairsDisplay = container.querySelector('.memory-pairs strong');
  const movesDisplay = container.querySelector('.memory-moves strong');
  const winEl = container.querySelector('.memory-win');

  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function initGame() {
    matchedPairs = 0;
    moves = 0;
    flippedCards = [];
    isLocked = false;

    pairsDisplay.textContent = '0';
    movesDisplay.textContent = '0';
    winEl.hidden = true;

    const selectedQuestions = shuffle(questions).slice(0, pairCount);

    cards = [];
    selectedQuestions.forEach((question, idx) => {
      cards.push({ id: `q-${idx}`, pairId: idx, content: question.prompt, type: 'question' });
      cards.push({ id: `a-${idx}`, pairId: idx, content: question.answer, type: 'answer' });
    });

    cards = shuffle(cards);
    renderGrid();
  }

  function renderGrid() {
    grid.innerHTML = cards.map(card => `
      <button class="memory-card" data-id="${card.id}" data-pair="${card.pairId}">
        <span class="card-back">?</span>
        <span class="card-front">${card.content}</span>
      </button>
    `).join('');
    
    grid.querySelectorAll('.memory-card').forEach(card => {
      card.addEventListener('click', () => flipCard(card));
    });
  }

  function flipCard(cardEl) {
    if (isLocked) return;
    if (cardEl.classList.contains('flipped')) return;
    if (cardEl.classList.contains('matched')) return;
    if (flippedCards.length >= 2) return;
    
    cardEl.classList.add('flipped');
    flippedCards.push(cardEl);
    
    if (flippedCards.length === 2) {
      moves++;
      movesDisplay.textContent = String(moves);
      checkMatch();
    }
  }

  function checkMatch() {
    isLocked = true;
    const [card1, card2] = flippedCards;
    const pair1 = card1.dataset.pair;
    const pair2 = card2.dataset.pair;
    
    if (pair1 === pair2) {
      card1.classList.add('matched');
      card2.classList.add('matched');
      matchedPairs++;
      pairsDisplay.textContent = String(matchedPairs);
      
      flippedCards = [];
      isLocked = false;
      
      if (matchedPairs === pairCount) {
        setTimeout(showWin, 500);
      }
    } else {
      setTimeout(() => {
        card1.classList.remove('flipped');
        card2.classList.remove('flipped');
        flippedCards = [];
        isLocked = false;
      }, 1000);
    }
  }

  function showWin() {
    winEl.hidden = false;
    winEl.querySelector('.win-stats').textContent = `Tu as trouv√© toutes les paires en ${moves} coups !`;
  }

  container.querySelector('.replay-btn')?.addEventListener('click', initGame);
  
  initGame();
</script>

<style>
  .memory-game {
    background: linear-gradient(145deg, #fdf4ff 0%, #faf5ff 50%, #f5f3ff 100%);
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: 0 10px 40px rgba(168, 85, 247, 0.15);
    border: 3px solid #e9d5ff;
  }

  .memory-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .memory-title {
    font-family: var(--font-display);
    font-size: 2rem;
    margin: 0;
    background: linear-gradient(135deg, #a855f7, #6366f1);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .memory-stats {
    display: flex;
    gap: 1rem;
    font-size: 1rem;
  }

  .memory-stats span {
    background: white;
    padding: 0.6rem 1rem;
    border-radius: var(--radius-full);
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 2px solid #e9d5ff;
  }

  .memory-stats strong {
    color: #a855f7;
    font-weight: 800;
  }

  .memory-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    max-width: 520px;
    margin: 0 auto;
    perspective: 1000px;
  }

  .memory-card {
    aspect-ratio: 1;
    background: linear-gradient(145deg, #a855f7, #7c3aed);
    border: none;
    border-radius: 1rem;
    cursor: pointer;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: inherit;
    box-shadow: 0 6px 20px rgba(168, 85, 247, 0.35);
  }

  .memory-card:hover:not(.flipped):not(.matched) {
    transform: scale(1.08) rotateZ(2deg);
    box-shadow: 0 10px 30px rgba(168, 85, 247, 0.45);
  }

  .memory-card.flipped,
  .memory-card.matched {
    transform: rotateY(180deg);
  }

  .memory-card.matched {
    background: linear-gradient(145deg, #22c55e, #16a34a);
    box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
  }

  .card-back,
  .card-front {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem;
    backface-visibility: hidden;
    border-radius: 1rem;
    font-weight: 700;
    font-size: clamp(0.85rem, 2.2vw, 1.1rem);
    text-align: center;
    word-break: break-word;
  }

  .card-back {
    background: linear-gradient(145deg, #a855f7, #7c3aed);
    color: white;
    font-size: 2.5rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .card-front {
    background: linear-gradient(145deg, #ffffff, #faf5ff);
    color: #1e1b4b;
    transform: rotateY(180deg);
    border: 4px solid #c084fc;
  }

  .memory-card.matched .card-front {
    border-color: #22c55e;
    background: linear-gradient(145deg, #dcfce7, #bbf7d0);
  }

  .memory-win {
    text-align: center;
    padding: 2.5rem;
    margin-top: 2rem;
    background: linear-gradient(135deg, #fef08a 0%, #d9f99d 50%, #a7f3d0 100%);
    border-radius: 1.5rem;
    animation: celebratePop 0.6s ease;
    border: 3px solid #86efac;
  }

  .memory-win .win-emoji {
    font-size: 5rem;
    display: block;
    margin-bottom: 0.75rem;
    animation: bounce 1s ease infinite;
  }

  .memory-win .win-text {
    font-family: var(--font-display);
    font-size: 2.5rem;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0 0 0.75rem;
  }

  .memory-win .win-stats {
    color: #374151;
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 1.5rem;
  }

  @keyframes celebratePop {
    0% { transform: scale(0.8); opacity: 0; }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); opacity: 1; }
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
  }

  @media (max-width: 480px) {
    .memory-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
    }
  }
</style>
