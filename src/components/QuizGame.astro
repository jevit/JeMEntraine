---
import type { Question, Level } from '../types/exercise';

interface Props {
  questions: Question[];
  level: Level;
  title: string;
}

const { questions, level, title } = Astro.props;
const quizId = `quiz-${Math.random().toString(36).slice(2, 9)}`;
---

<div class="quiz-game" id={quizId}>
  <div class="quiz-header">
    <h2 class="quiz-title">ðŸŽ¯ {title}</h2>
    <div class="quiz-progress">
      <div class="quiz-progress-bar">
        <div class="quiz-progress-fill"></div>
      </div>
      <span class="quiz-progress-text">1 / {questions.length}</span>
    </div>
  </div>
  
  <div class="quiz-content">
    <div class="quiz-question-box">
      <p class="quiz-question"></p>
    </div>
    
    <div class="quiz-answers"></div>
    
    <div class="quiz-feedback" hidden>
      <span class="feedback-icon"></span>
      <span class="feedback-text"></span>
    </div>
  </div>
  
  <div class="quiz-score" hidden>
    <span class="score-emoji">ðŸŽ‰</span>
    <p class="score-value"></p>
    <p class="score-message"></p>
    <button type="button" class="btn btn--primary btn--lg replay-btn">ðŸ”„ Rejouer</button>
  </div>
</div>

<script define:vars={{ questions, quizId }}>
  const container = document.getElementById(quizId);
  if (!container) throw new Error('Quiz container not found');

  let currentIndex = 0;
  let score = 0;
  let hasAnswered = false;

  const shuffledQuestions = [...questions].sort(() => Math.random() - 0.5).slice(0, 10);

  const progressFill = container.querySelector('.quiz-progress-fill');
  const progressText = container.querySelector('.quiz-progress-text');
  const questionEl = container.querySelector('.quiz-question');
  const answersEl = container.querySelector('.quiz-answers');
  const feedbackEl = container.querySelector('.quiz-feedback');
  const scoreEl = container.querySelector('.quiz-score');
  const contentEl = container.querySelector('.quiz-content');

  function generateOptions(correct, allQuestions) {
    const opts = new Set([correct]);
    const num = parseInt(correct);

    if (!isNaN(num)) {
      while (opts.size < 4) {
        const delta = Math.floor(Math.random() * 6) - 3;
        if (delta !== 0) opts.add(String(num + delta));
      }
    } else {
      const others = allQuestions.map(q => q.answer).filter(a => a !== correct);
      others.sort(() => Math.random() - 0.5);
      for (const o of others) {
        if (opts.size >= 4) break;
        opts.add(o);
      }
    }
    return [...opts].sort(() => Math.random() - 0.5);
  }

  function showQuestion() {
    const question = shuffledQuestions[currentIndex];
    if (!question) return showScore();

    hasAnswered = false;
    const progress = ((currentIndex) / shuffledQuestions.length) * 100;
    progressFill.style.width = `${progress}%`;
    progressText.textContent = `${currentIndex + 1} / ${shuffledQuestions.length}`;
    questionEl.textContent = question.prompt;
    feedbackEl.hidden = true;

    const options = question.options || generateOptions(question.answer, shuffledQuestions);
    answersEl.innerHTML = options.map(opt =>
      `<button class="quiz-answer" data-value="${opt}">${opt}</button>`
    ).join('');

    answersEl.querySelectorAll('.quiz-answer').forEach(btn => {
      btn.addEventListener('click', () => handleAnswer(btn, question.answer));
    });
  }

  function handleAnswer(btn, correct) {
    if (hasAnswered) return;
    hasAnswered = true;

    const value = btn.dataset.value;
    const isCorrect = value === correct;

    if (isCorrect) {
      score++;
      btn.classList.add('correct');
      feedbackEl.querySelector('.feedback-icon').textContent = 'âœ…';
      feedbackEl.querySelector('.feedback-text').textContent = 'Bravo !';
    } else {
      btn.classList.add('incorrect');
      answersEl.querySelectorAll('.quiz-answer').forEach(b => {
        if (b.dataset.value === correct) b.classList.add('correct');
      });
      feedbackEl.querySelector('.feedback-icon').textContent = 'âŒ';
      feedbackEl.querySelector('.feedback-text').textContent = `La rÃ©ponse Ã©tait : ${correct}`;
    }

    feedbackEl.hidden = false;

    setTimeout(() => {
      currentIndex++;
      if (currentIndex < shuffledQuestions.length) {
        showQuestion();
      } else {
        showScore();
      }
    }, 1500);
  }

  function showScore() {
    contentEl.hidden = true;
    scoreEl.hidden = false;
    progressFill.style.width = '100%';

    const pct = Math.round((score / shuffledQuestions.length) * 100);
    scoreEl.querySelector('.score-value').textContent = `${score} / ${shuffledQuestions.length}`;

    let emoji = 'ðŸŽ‰';
    let msg = 'Super champion !';
    if (pct < 50) { emoji = 'ðŸ’ª'; msg = 'Continue, tu vas y arriver !'; }
    else if (pct < 80) { emoji = 'ðŸ‘'; msg = 'Bien jouÃ© !'; }

    scoreEl.querySelector('.score-emoji').textContent = emoji;
    scoreEl.querySelector('.score-message').textContent = msg;
  }

  container.querySelector('.replay-btn')?.addEventListener('click', () => {
    currentIndex = 0;
    score = 0;
    shuffledQuestions.sort(() => Math.random() - 0.5);
    contentEl.hidden = false;
    scoreEl.hidden = true;
    showQuestion();
  });

  showQuestion();
</script>

<style>
  .quiz-game {
    background: linear-gradient(145deg, #ffffff 0%, #f0f9ff 100%);
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: 0 10px 40px rgba(99, 102, 241, 0.15);
    max-width: 650px;
    margin: 0 auto;
    border: 3px solid #c7d2fe;
  }

  .quiz-header {
    margin-bottom: 2rem;
  }

  .quiz-title {
    font-family: var(--font-display);
    font-size: 2rem;
    text-align: center;
    margin-bottom: 1.25rem;
    background: linear-gradient(135deg, #6366f1, #ec4899);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .quiz-progress {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .quiz-progress-bar {
    flex: 1;
    height: 16px;
    background: #e0e7ff;
    border-radius: var(--radius-full);
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
  }

  .quiz-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #6366f1, #a855f7, #ec4899);
    transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    width: 0%;
    border-radius: var(--radius-full);
  }

  .quiz-progress-text {
    font-weight: 800;
    color: #6366f1;
    font-size: 1rem;
    min-width: 70px;
    text-align: center;
    background: #e0e7ff;
    padding: 0.5rem 0.75rem;
    border-radius: var(--radius-full);
  }

  .quiz-question-box {
    padding: 2rem;
    background: linear-gradient(135deg, #fef08a 0%, #fce7f3 50%, #ddd6fe 100%);
    border-radius: 1.5rem;
    margin-bottom: 2rem;
    text-align: center;
    box-shadow: 0 8px 25px rgba(251, 191, 36, 0.2);
    border: 3px solid #fcd34d;
    animation: float 3s ease-in-out infinite;
  }

  .quiz-question {
    font-family: var(--font-display);
    font-size: 1.75rem;
    margin: 0;
    color: #1e1b4b;
  }

  .quiz-answers {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .quiz-answer {
    padding: 1.5rem;
    background: linear-gradient(145deg, #ffffff, #f8fafc);
    border: 4px solid #e0e7ff;
    border-radius: 1rem;
    font-size: 1.25rem;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }

  .quiz-answer:hover:not(.correct):not(.incorrect) {
    border-color: #6366f1;
    background: linear-gradient(145deg, #eef2ff, #ffffff);
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.25);
  }

  .quiz-answer.correct {
    border-color: #22c55e;
    background: linear-gradient(145deg, #dcfce7, #bbf7d0);
    animation: correctPop 0.5s ease;
    box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
  }

  .quiz-answer.incorrect {
    border-color: #ef4444;
    background: linear-gradient(145deg, #fee2e2, #fecaca);
    animation: shake 0.5s ease;
  }

  .quiz-feedback {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    margin-top: 1.5rem;
    padding: 1.25rem;
    border-radius: 1rem;
    font-weight: 700;
    font-size: 1.1rem;
    background: #f0fdf4;
    border: 2px solid #86efac;
  }

  .quiz-score {
    text-align: center;
    padding: 2.5rem;
    background: linear-gradient(135deg, #fef08a 0%, #d9f99d 50%, #a7f3d0 100%);
    border-radius: 1.5rem;
    animation: celebratePop 0.6s ease;
  }

  .quiz-score .score-emoji {
    font-size: 5rem;
    display: block;
    margin-bottom: 1rem;
    animation: bounce 1s ease infinite;
  }

  .quiz-score .score-value {
    font-family: var(--font-display);
    font-size: 3rem;
    background: linear-gradient(135deg, #6366f1, #ec4899);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0 0 0.5rem;
  }

  .quiz-score .score-message {
    color: #374151;
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 1.5rem;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }

  @keyframes correctPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(1); }
  }

  @keyframes celebratePop {
    0% { transform: scale(0.8); opacity: 0; }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); opacity: 1; }
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    75% { transform: translateX(8px); }
  }

  @media (max-width: 480px) {
    .quiz-answers {
      grid-template-columns: 1fr;
    }
    .quiz-question {
      font-size: 1.4rem;
    }
  }
</style>
