---
/**
 * ExerciseItems - Composant d'affichage des questions
 *
 * Bonnes pratiques d'apprentissage appliquÃ©es :
 * - Questions numÃ©rotÃ©es clairement
 * - Feedback visuel immÃ©diat
 * - Indices accessibles mais non intrusifs
 * - Zones de clic larges pour enfants
 * - Progression visuelle
 */
import type { ExerciseItem } from '../types/exercise';

interface Props {
  items: ExerciseItem[];
  interactive?: boolean;
  showProgress?: boolean;
}

const { items, interactive = true, showProgress = true } = Astro.props;
const totalItems = items.length;
---

<div class="exercise-items" data-total={totalItems}>
  {/* Barre de progression pour encourager */}
  {showProgress && (
    <div class="exercise-progress" aria-hidden="true">
      <div class="progress">
        <div class="progress__bar" style="width: 0%" data-progress-bar></div>
      </div>
      <p class="exercise-progress__text">
        <span data-answered>0</span> / {totalItems} questions
      </p>
    </div>
  )}

  {items.map((item, index) => (
    <article
      class="exercise-item animate-slideUp"
      data-index={index}
      style={`animation-delay: ${index * 80}ms`}
      aria-label={`Question ${index + 1} sur ${totalItems}`}
    >
      <div class="item-number" aria-hidden="true">{index + 1}</div>

      <div class="item-content">
        <p class="item-question" id={`question-${index}`}>{item.q}</p>

        {interactive && !item.options && (
          <div class="item-input-wrapper">
            <input
              type="text"
              class="item-input"
              placeholder="Ã‰cris ta rÃ©ponse ici..."
              data-answer={item.a}
              aria-labelledby={`question-${index}`}
              aria-describedby={item.hint ? `hint-${index}` : undefined}
              autocomplete="off"
              spellcheck="false"
            />
            <span class="item-feedback" aria-live="polite"></span>
          </div>
        )}

        {item.options && item.options.length > 0 && (
          <div class="item-options" role="group" aria-labelledby={`question-${index}`}>
            {item.options.map((option, optIndex) => (
              <button
                type="button"
                class="item-option"
                data-value={option}
                data-correct={option === item.a}
                aria-pressed="false"
              >
                <span class="item-option__letter">{String.fromCharCode(65 + optIndex)}</span>
                <span class="item-option__text">{option}</span>
              </button>
            ))}
          </div>
        )}

        {item.hint && (
          <details class="item-hint-toggle">
            <summary class="item-hint-btn">
              <span class="item-hint-btn__icon">ðŸ’¡</span>
              <span>Besoin d'aide ?</span>
            </summary>
            <p class="item-hint" id={`hint-${index}`}>
              {item.hint}
            </p>
          </details>
        )}
      </div>
    </article>
  ))}

  {/* Message d'encouragement Ã  la fin */}
  <div class="exercise-encouragement hidden" data-encouragement>
    <div class="encouragement">
      <span class="encouragement__emoji">ðŸŒŸ</span>
      <p class="encouragement__text">Bravo, tu as terminÃ© !</p>
    </div>
  </div>
</div>

<style>
  /* ========================================
     LISTE DES QUESTIONS
     ======================================== */
  .exercise-items {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
    margin-bottom: var(--space-8);
  }

  /* Barre de progression */
  .exercise-progress {
    margin-bottom: var(--space-6);
    text-align: center;
  }

  .exercise-progress__text {
    margin-top: var(--space-2);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    font-weight: 600;
  }

  /* ========================================
     QUESTION INDIVIDUELLE
     ======================================== */
  .exercise-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-5);
    padding: var(--space-6);
    background: var(--color-bg-card);
    border-radius: var(--radius-lg);
    border: 2px solid transparent;
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-base);
    opacity: 0;
  }

  .exercise-item:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary-light);
  }

  .exercise-item.answered {
    border-color: var(--color-success-border);
    background: var(--color-success-light);
  }

  .exercise-item.answered .item-number {
    background: var(--color-success);
  }

  /* NumÃ©ro de question */
  .item-number {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    height: 44px;
    background: var(--color-primary);
    color: white;
    border-radius: 50%;
    font-family: var(--font-display);
    font-weight: 700;
    font-size: var(--text-lg);
    flex-shrink: 0;
    transition: background var(--transition-base);
  }

  /* Contenu de la question */
  .item-content {
    flex: 1;
    min-width: 0;
  }

  .item-question {
    font-size: var(--text-lg);
    font-weight: 600;
    line-height: 1.6;
    margin-bottom: var(--space-4);
    color: var(--color-text);
  }

  /* ========================================
     CHAMP DE RÃ‰PONSE
     ======================================== */
  .item-input-wrapper {
    position: relative;
  }

  .item-input {
    width: 100%;
    min-height: 52px;
    padding: var(--space-4) var(--space-5);
    border: 3px dashed #CBD5E1;
    border-radius: var(--radius-md);
    font-size: var(--text-base);
    font-family: var(--font-body);
    background: #F8FAFC;
    transition: all var(--transition-fast);
  }

  .item-input::placeholder {
    color: var(--color-text-light);
    font-style: italic;
  }

  .item-input:focus {
    outline: none;
    border-style: solid;
    border-color: var(--color-primary);
    background: white;
    box-shadow: var(--shadow-focus);
  }

  .item-input.correct {
    border-style: solid;
    border-color: var(--color-success);
    background: var(--color-success-light);
    box-shadow: var(--shadow-success);
  }

  .item-input.incorrect {
    border-style: solid;
    border-color: var(--color-error);
    background: var(--color-error-light);
    box-shadow: var(--shadow-error);
  }

  /* Feedback de rÃ©ponse */
  .item-feedback {
    display: none;
    position: absolute;
    right: var(--space-4);
    top: 50%;
    transform: translateY(-50%);
    font-size: var(--text-xl);
  }

  .item-input.correct + .item-feedback,
  .item-input.incorrect + .item-feedback {
    display: block;
  }

  .item-input.correct + .item-feedback::after {
    content: "âœ“";
    color: var(--color-success);
  }

  .item-input.incorrect + .item-feedback::after {
    content: "âœ—";
    color: var(--color-error);
  }

  /* ========================================
     OPTIONS QCM
     ======================================== */
  .item-options {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    margin-top: var(--space-3);
  }

  .item-option {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    min-height: 52px;
    padding: var(--space-3) var(--space-5);
    background: #F8FAFC;
    border: 3px solid #E2E8F0;
    border-radius: var(--radius-lg);
    font-family: var(--font-body);
    font-size: var(--text-base);
    font-weight: 500;
    text-align: left;
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .item-option:hover:not(.selected):not(.correct):not(.incorrect) {
    border-color: var(--color-primary);
    background: var(--color-primary-bg);
    transform: translateX(4px);
  }

  .item-option:focus-visible {
    border-color: var(--color-primary);
    box-shadow: var(--shadow-focus);
  }

  .item-option__letter {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: #E2E8F0;
    border-radius: 50%;
    font-family: var(--font-display);
    font-weight: 700;
    font-size: var(--text-sm);
    flex-shrink: 0;
    transition: all var(--transition-fast);
  }

  .item-option:hover .item-option__letter {
    background: var(--color-primary);
    color: white;
  }

  .item-option.selected {
    border-color: var(--color-primary);
    background: var(--color-primary-bg);
  }

  .item-option.selected .item-option__letter {
    background: var(--color-primary);
    color: white;
  }

  .item-option.correct {
    border-color: var(--color-success);
    background: var(--color-success-light);
  }

  .item-option.correct .item-option__letter {
    background: var(--color-success);
    color: white;
  }

  .item-option.incorrect {
    border-color: var(--color-error);
    background: var(--color-error-light);
  }

  .item-option.incorrect .item-option__letter {
    background: var(--color-error);
    color: white;
  }

  /* ========================================
     INDICES / AIDE
     ======================================== */
  .item-hint-toggle {
    margin-top: var(--space-4);
  }

  .item-hint-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: var(--color-warning-light);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-warning-dark);
    cursor: pointer;
    transition: all var(--transition-fast);
    list-style: none;
  }

  .item-hint-btn::-webkit-details-marker {
    display: none;
  }

  .item-hint-btn:hover {
    background: #FDE68A;
  }

  .item-hint-btn__icon {
    font-size: var(--text-base);
  }

  .item-hint {
    margin-top: var(--space-3);
    padding: var(--space-4);
    background: var(--color-warning-light);
    border-radius: var(--radius-md);
    border-left: 4px solid var(--color-warning);
    font-size: var(--text-sm);
    color: var(--color-text);
    line-height: 1.6;
  }

  /* ========================================
     ENCOURAGEMENT
     ======================================== */
  .exercise-encouragement {
    margin-top: var(--space-8);
    padding: var(--space-8);
    background: linear-gradient(135deg, var(--color-success-light), #ECFDF5);
    border-radius: var(--radius-xl);
    border: 3px solid var(--color-success-border);
    text-align: center;
  }

  .exercise-encouragement.hidden {
    display: none;
  }

  /* ========================================
     RESPONSIVE
     ======================================== */
  @media (max-width: 768px) {
    .exercise-item {
      flex-direction: column;
      gap: var(--space-4);
      padding: var(--space-5);
    }

    .item-number {
      min-width: 36px;
      height: 36px;
      font-size: var(--text-base);
    }

    .item-question {
      font-size: var(--text-base);
    }

    .item-option {
      padding: var(--space-4);
    }

    .item-options {
      gap: var(--space-2);
    }
  }
</style>
