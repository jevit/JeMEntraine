---
import type { Question, Level } from '../types/exercise';

interface Props {
  questions: Question[];
  level: Level;
  title: string;
}

const { questions, level, title } = Astro.props;
const matchingId = `matching-${Math.random().toString(36).slice(2, 9)}`;
const pairCount = level === 'CP' ? 4 : level === 'CE1' ? 5 : 6;
---

<div class="matching-game" id={matchingId}>
  <div class="matching-header">
    <h2 class="matching-title">ðŸ”— {title}</h2>
    <span class="matching-score">âœ… <strong>0</strong> / {pairCount} reliÃ©s</span>
  </div>
  
  <p class="matching-instruction">Clique sur un Ã©lÃ©ment Ã  gauche, puis sur son correspondant Ã  droite.</p>
  
  <div class="matching-container">
    <div class="matching-column matching-left">
      <span class="column-label">Questions</span>
      <div class="matching-items"></div>
    </div>
    
    <div class="matching-lines">
      <svg class="lines-svg"></svg>
    </div>
    
    <div class="matching-column matching-right">
      <span class="column-label">RÃ©ponses</span>
      <div class="matching-items"></div>
    </div>
  </div>
  
  <div class="matching-win" hidden>
    <span class="win-emoji">ðŸŽ‰</span>
    <p class="win-text">Bravo, tout est reliÃ© !</p>
    <button type="button" class="btn btn--primary btn--lg replay-btn">ðŸ”„ Rejouer</button>
  </div>
</div>

<script define:vars={{ questions, matchingId, pairCount }}>
  const container = document.getElementById(matchingId);
  if (!container) throw new Error('Matching container not found');

  let selected = null;
  let matchedCount = 0;
  let pairs = [];

  const leftCol = container.querySelector('.matching-left .matching-items');
  const rightCol = container.querySelector('.matching-right .matching-items');
  const scoreDisplay = container.querySelector('.matching-score strong');
  const winEl = container.querySelector('.matching-win');
  const linesSvg = container.querySelector('.lines-svg');

  function shuffle(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function initGame() {
    matchedCount = 0;
    selected = null;
    pairs = [];
    scoreDisplay.textContent = '0';
    winEl.hidden = true;
    linesSvg.innerHTML = '';

    const selectedQuestions = shuffle(questions).slice(0, pairCount);

    const leftItems = selectedQuestions.map((question, idx) => ({
      id: `left-${idx}`,
      pairId: idx,
      content: question.prompt
    }));

    const rightItems = shuffle(selectedQuestions.map((question, idx) => ({
      id: `right-${idx}`,
      pairId: idx,
      content: question.answer
    })));
    
    leftCol.innerHTML = leftItems.map(item => `
      <button class="match-item" data-id="${item.id}" data-pair="${item.pairId}" data-side="left">
        ${item.content}
      </button>
    `).join('');
    
    rightCol.innerHTML = rightItems.map(item => `
      <button class="match-item" data-id="${item.id}" data-pair="${item.pairId}" data-side="right">
        ${item.content}
      </button>
    `).join('');
    
    container.querySelectorAll('.match-item').forEach(item => {
      item.addEventListener('click', () => handleClick(item));
    });
  }

  function handleClick(item) {
    if (item.classList.contains('matched')) return;
    
    const side = item.dataset.side;
    
    if (!selected) {
      selected = item;
      item.classList.add('selected');
    } else if (selected === item) {
      selected.classList.remove('selected');
      selected = null;
    } else if (selected.dataset.side === side) {
      selected.classList.remove('selected');
      selected = item;
      item.classList.add('selected');
    } else {
      // VÃ©rifier la correspondance
      const pair1 = selected.dataset.pair;
      const pair2 = item.dataset.pair;
      
      if (pair1 === pair2) {
        // Match !
        selected.classList.remove('selected');
        selected.classList.add('matched');
        item.classList.add('matched');
        
        pairs.push({ left: selected, right: item });
        drawLine(selected, item);
        
        matchedCount++;
        scoreDisplay.textContent = String(matchedCount);
        
        if (matchedCount === pairCount) {
          setTimeout(() => { winEl.hidden = false; }, 500);
        }
      } else {
        // Pas de match
        selected.classList.add('wrong');
        item.classList.add('wrong');
        
        setTimeout(() => {
          selected.classList.remove('selected', 'wrong');
          item.classList.remove('wrong');
          selected = null;
        }, 500);
        return;
      }
      
      selected = null;
    }
  }

  function drawLine(el1, el2) {
    const containerRect = container.querySelector('.matching-container').getBoundingClientRect();
    const rect1 = el1.getBoundingClientRect();
    const rect2 = el2.getBoundingClientRect();
    
    const x1 = rect1.right - containerRect.left;
    const y1 = rect1.top + rect1.height / 2 - containerRect.top;
    const x2 = rect2.left - containerRect.left;
    const y2 = rect2.top + rect2.height / 2 - containerRect.top;
    
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', x1);
    line.setAttribute('y1', y1);
    line.setAttribute('x2', x2);
    line.setAttribute('y2', y2);
    line.setAttribute('stroke', '#22c55e');
    line.setAttribute('stroke-width', '3');
    line.setAttribute('stroke-linecap', 'round');
    
    linesSvg.appendChild(line);
  }

  container.querySelector('.replay-btn')?.addEventListener('click', initGame);
  
  initGame();
</script>

<style>
  .matching-game {
    background: linear-gradient(145deg, #ecfdf5 0%, #f0fdf4 50%, #fefce8 100%);
    border-radius: var(--radius-lg);
    padding: 2rem;
    box-shadow: 0 10px 40px rgba(34, 197, 94, 0.15);
    border: 3px solid #bbf7d0;
  }

  .matching-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .matching-title {
    font-family: var(--font-display);
    font-size: 2rem;
    margin: 0;
    background: linear-gradient(135deg, #22c55e, #0d9488);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .matching-score {
    font-size: 1rem;
    background: white;
    padding: 0.6rem 1.25rem;
    border-radius: var(--radius-full);
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    border: 2px solid #bbf7d0;
  }

  .matching-score strong {
    color: #22c55e;
    font-weight: 800;
    font-size: 1.1rem;
  }

  .matching-instruction {
    text-align: center;
    color: #374151;
    margin-bottom: 2rem;
    font-size: 1.05rem;
    background: white;
    padding: 1rem;
    border-radius: 1rem;
    border: 2px dashed #86efac;
  }

  .matching-container {
    display: flex;
    gap: 2rem;
    position: relative;
  }

  .matching-column {
    flex: 1;
  }

  .column-label {
    display: block;
    text-align: center;
    font-weight: 800;
    color: white;
    font-size: 0.9rem;
    text-transform: uppercase;
    margin-bottom: 1rem;
    padding: 0.6rem;
    border-radius: var(--radius-full);
    letter-spacing: 0.05em;
  }

  .matching-left .column-label {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
  }

  .matching-right .column-label {
    background: linear-gradient(135deg, #f59e0b, #f97316);
  }

  .matching-items {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .match-item {
    padding: 1.25rem 1.5rem;
    background: linear-gradient(145deg, #ffffff, #f8fafc);
    border: 4px solid #e2e8f0;
    border-radius: 1rem;
    font-size: 1.1rem;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }

  .match-item:hover:not(.matched) {
    border-color: #6366f1;
    background: linear-gradient(145deg, #eef2ff, #ffffff);
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
  }

  .match-item.selected {
    border-color: #6366f1;
    background: linear-gradient(145deg, #6366f1, #4f46e5);
    color: white;
    transform: scale(1.03);
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
  }

  .match-item.matched {
    border-color: #22c55e;
    background: linear-gradient(145deg, #dcfce7, #bbf7d0);
    color: #166534;
    cursor: default;
    box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2);
  }

  .match-item.wrong {
    border-color: #ef4444;
    background: linear-gradient(145deg, #fee2e2, #fecaca);
    animation: shake 0.4s ease;
  }

  .matching-lines {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .lines-svg {
    width: 100%;
    height: 100%;
  }

  .matching-win {
    text-align: center;
    padding: 2.5rem;
    margin-top: 2rem;
    background: linear-gradient(135deg, #fef08a 0%, #d9f99d 50%, #a7f3d0 100%);
    border-radius: 1.5rem;
    animation: celebratePop 0.6s ease;
    border: 3px solid #86efac;
  }

  .matching-win .win-emoji {
    font-size: 5rem;
    display: block;
    margin-bottom: 0.75rem;
    animation: bounce 1s ease infinite;
  }

  .matching-win .win-text {
    font-family: var(--font-display);
    font-size: 2rem;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 0 0 1.5rem;
  }

  @keyframes celebratePop {
    0% { transform: scale(0.8); opacity: 0; }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); opacity: 1; }
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    75% { transform: translateX(8px); }
  }

  @media (max-width: 600px) {
    .matching-container {
      flex-direction: column;
      gap: 1.5rem;
    }

    .matching-lines {
      display: none;
    }
  }
</style>
